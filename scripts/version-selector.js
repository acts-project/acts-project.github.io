/**
 * ACTS Version Selector
 * Auto-generated by deploy_docs.py
 */
(function() {
  'use strict';

  async function fetchVersions(siteRoot) {
    try {
      const response = await fetch(`${siteRoot}/versions.json`, { cache: 'no-store' });
      if (!response.ok) return null;
      return await response.json();
    } catch (error) {
      console.error('[ACTS] Failed to fetch versions.json:', error);
      return null;
    }
  }

  function detectCurrentVersion(currentPath) {
    // Check if we're in a tagged version: /tags/v1.2.3/...
    const match = currentPath.match(/\/tags\/v([\d.]+(?:-[\w.]+)?)/);
    if (match) {
      return { type: 'tag', version: match[1] };
    }
    // Otherwise we're on main
    return { type: 'main', version: null };
  }

  function createDropdown(versions, currentVersion, siteRoot) {
    const container = document.createElement('div');
    container.className = 'acts-version-dropdown';

    const label = document.createElement('label');
    label.textContent = 'Version: ';
    label.htmlFor = 'acts-version-select';

    const select = document.createElement('select');
    select.id = 'acts-version-select';

    // Add main option
    const mainOption = document.createElement('option');
    mainOption.value = '';
    mainOption.textContent = 'main (development)';
    if (currentVersion.type === 'main') {
      mainOption.selected = true;
    }
    select.appendChild(mainOption);

    // Add version options (already sorted by semver descending)
    for (let i = 0; i < versions.versions.length; i++) {
      const v = versions.versions[i];
      const option = document.createElement('option');
      option.value = v.path;
      option.textContent = i === 0 ? `v${v.version} (latest)` : `v${v.version}`;
      if (currentVersion.type === 'tag' && currentVersion.version === v.version) {
        option.selected = true;
      }
      select.appendChild(option);
    }

    // Handle version change - always go to index.html
    select.addEventListener('change', function() {
      const selectedPath = this.value;
      let newUrl;
      if (selectedPath === '') {
        newUrl = `${siteRoot}/index.html`;
      } else {
        newUrl = `${siteRoot}/${selectedPath}/index.html`;
      }
      window.location.href = newUrl;
    });

    container.appendChild(label);
    container.appendChild(select);

    return container;
  }

  function createOutdatedBanner(versions, currentVersion, siteRoot) {
    // Only show for tagged versions that aren't the latest
    if (currentVersion.type !== 'tag' || versions.versions.length === 0) {
      return null;
    }

    const latestVersion = versions.versions[0];
    if (currentVersion.version === latestVersion.version) {
      return null; // This is the latest, no banner needed
    }

    const banner = document.createElement('div');
    banner.className = 'acts-outdated-banner';
    banner.innerHTML = `
      <strong>You are viewing documentation for an older version (v${currentVersion.version}).</strong><br>
      <a href="${siteRoot}/${latestVersion.path}/index.html">View latest stable (v${latestVersion.version})</a>
      &nbsp;|&nbsp;
      <a href="${siteRoot}/index.html">View development (main)</a>
    `;

    return banner;
  }

  function addStyles() {
    const style = document.createElement('style');
    style.textContent = `
      .acts-version-dropdown {
        padding: 10px;
        margin-bottom: 10px;
      }
      .acts-version-dropdown label {
        font-weight: bold;
        margin-right: 5px;
      }
      .acts-version-dropdown select {
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        background: white;
        cursor: pointer;
      }
      .acts-outdated-banner {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 4px;
        padding: 12px 16px;
        margin-bottom: 16px;
        color: #856404;
      }
      .acts-outdated-banner a {
        color: #533f03;
        font-weight: bold;
      }
    `;
    document.head.appendChild(style);
  }

  window.initVersionSelector = async function(options) {
    const { container, currentPath, siteRoot } = options;

    const containerEl = document.querySelector(container);
    if (!containerEl) {
      console.error('[ACTS] Version selector container not found:', container);
      return;
    }

    const versions = await fetchVersions(siteRoot);
    if (!versions || (!versions.main && versions.versions.length === 0)) {
      console.log('[ACTS] No versions available');
      containerEl.remove();
      return;
    }

    addStyles();

    const currentVersion = detectCurrentVersion(currentPath);
    const dropdown = createDropdown(versions, currentVersion, siteRoot);
    containerEl.appendChild(dropdown);

    // Add outdated banner if needed
    const banner = createOutdatedBanner(versions, currentVersion, siteRoot);
    if (banner) {
      const docContent = document.querySelector('#doc-content');
      if (docContent) {
        docContent.prepend(banner);
      }
    }

    console.log('[ACTS] Version selector rendered, current:', currentVersion);
  };
})();
