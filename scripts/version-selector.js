/**
 * ACTS Version Selector
 * Auto-generated by deploy_docs.py
 */
(function() {
  'use strict';

  let initialized = false;

  async function fetchVersions(siteRoot) {
    try {
      const response = await fetch(`${siteRoot}/versions.json`, { cache: 'no-store' });
      if (!response.ok) return null;
      return await response.json();
    } catch (error) {
      console.error('[ACTS] Failed to fetch versions.json:', error);
      return null;
    }
  }

  function detectCurrentVersion(currentPath) {
    const match = currentPath.match(/\/tags\/v([\d.]+(?:-[\w.]+)?)/);
    if (match) {
      return { type: 'tag', version: match[1] };
    }
    return { type: 'main', version: null };
  }

  function isOutdated(versions, currentVersion) {
    if (currentVersion.type !== 'tag' || versions.versions.length === 0) {
      return false;
    }
    return currentVersion.version !== versions.versions[0].version;
  }

  function createVersionBanner(versions, currentVersion, siteRoot) {
    const outdated = isOutdated(versions, currentVersion);
    const latestVersion = versions.versions[0];

    const banner = document.createElement('div');
    banner.className = 'acts-version-banner';
    if (outdated) {
      banner.classList.add('acts-version-banner--outdated');
    }

    // Warning text for outdated versions
    let warningHtml = '';
    if (outdated) {
      warningHtml = `
        <div class="acts-version-warning">
          <strong>You are viewing documentation for an older version (v${currentVersion.version}).</strong>
          <a href="${siteRoot}/${latestVersion.path}/index.html">View latest stable (v${latestVersion.version})</a>
          or
          <a href="${siteRoot}/index.html">development (main)</a>
        </div>
      `;
    }

    // Build select options
    let optionsHtml = `<option value="">main (development)</option>`;
    for (let i = 0; i < versions.versions.length; i++) {
      const v = versions.versions[i];
      const label = i === 0 ? `v${v.version} (latest)` : `v${v.version}`;
      const selected = (currentVersion.type === 'tag' && currentVersion.version === v.version) ? 'selected' : '';
      optionsHtml += `<option value="${v.path}" ${selected}>${label}</option>`;
    }

    // Select main if on main
    if (currentVersion.type === 'main') {
      optionsHtml = optionsHtml.replace('value="">', 'value="" selected>');
    }

    banner.innerHTML = `
      ${warningHtml}
      <div class="acts-version-select">
        <label for="acts-version-select">Version:</label>
        <select id="acts-version-select">
          ${optionsHtml}
        </select>
      </div>
    `;

    // Handle version change
    const select = banner.querySelector('select');
    select.addEventListener('change', function() {
      const selectedPath = this.value;
      let newUrl;
      if (selectedPath === '') {
        newUrl = `${siteRoot}/index.html`;
      } else {
        newUrl = `${siteRoot}/${selectedPath}/index.html`;
      }
      window.location.href = newUrl;
    });

    return banner;
  }

  function addStyles() {
    const style = document.createElement('style');
    style.textContent = `
      .acts-version-banner {
        background: #e7f3ff;
        border: 1px solid #b3d7ff;
        border-radius: 4px;
        padding: 12px 16px;
        margin-bottom: 16px;
        color: #1a4a6e;
      }
      .acts-version-banner--outdated {
        background: #fff3cd;
        border-color: #ffc107;
        color: #856404;
      }
      .acts-version-warning {
        margin-bottom: 10px;
      }
      .acts-version-warning a {
        color: #533f03;
        font-weight: bold;
      }
      .acts-version-select label {
        font-weight: bold;
        margin-right: 8px;
      }
      .acts-version-select select {
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        background: white;
        color: #333;
        cursor: pointer;
      }

      /* System dark mode preference (when no explicit toggle) */
      @media (prefers-color-scheme: dark) {
        html:not(.light-mode):not(.dark-mode) .acts-version-banner {
          background: #1e3a5f;
          border-color: #2d5a8a;
          color: #b3d7ff;
        }
        html:not(.light-mode):not(.dark-mode) .acts-version-banner--outdated {
          background: #4a3c00;
          border-color: #6b5a00;
          color: #ffd966;
        }
        html:not(.light-mode):not(.dark-mode) .acts-version-warning a {
          color: #ffeb99;
        }
        html:not(.light-mode):not(.dark-mode) .acts-version-select select {
          background: #2a2a2a;
          border-color: #555;
          color: #eee;
        }
      }

      /* Explicit dark mode toggle */
      html.dark-mode .acts-version-banner {
        background: #1e3a5f;
        border-color: #2d5a8a;
        color: #b3d7ff;
      }
      html.dark-mode .acts-version-banner--outdated {
        background: #4a3c00;
        border-color: #6b5a00;
        color: #ffd966;
      }
      html.dark-mode .acts-version-warning a {
        color: #ffeb99;
      }
      html.dark-mode .acts-version-select select {
        background: #2a2a2a;
        border-color: #555;
        color: #eee;
      }
    `;
    document.head.appendChild(style);
  }

  window.initVersionSelector = async function(options) {
    // Only initialize once, in the content area
    if (initialized) return;
    initialized = true;

    const { currentPath, siteRoot } = options;

    const versions = await fetchVersions(siteRoot);
    if (!versions || (!versions.main && versions.versions.length === 0)) {
      console.log('[ACTS] No versions available');
      return;
    }

    addStyles();

    const currentVersion = detectCurrentVersion(currentPath);
    const banner = createVersionBanner(versions, currentVersion, siteRoot);

    const docContent = document.querySelector('#doc-content');
    if (docContent) {
      docContent.prepend(banner);
    }

    // Remove the sidebar container since we're using the banner instead
    const sidebarContainer = document.querySelector('#acts-version-selector');
    if (sidebarContainer) {
      sidebarContainer.remove();
    }

    console.log('[ACTS] Version banner rendered, current:', currentVersion);
  };
})();
