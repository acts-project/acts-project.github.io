<!-- HTML header for doxygen 1.12.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACTS: Python Bindings for Examples</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script>
MathJax = {
  tex: {
    inlineMath: {'[+]': [['$', '$']]}
  },
};
</script>
<script id="MathJax-script" async src="tex-mml-chtml.js"></script>
<!-- <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
 -->
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
</script>
<!-- ACTS Version Manager -->
<link href="acts-version-manager.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="acts-version-manager.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="acts_logo_colored.svg"/></td>
  <td id="projectalign">
   <div id="projectname">ACTS
   </div>
   <div id="projectbrief">Experiment-independent tracking</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('python_bindings.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Python Bindings for Examples </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The examples part of ACTS ships with python bindings using the <span class="tt">pybind11</span> library. Building these bindings can be enabled via <span class="tt">-DACTS_BUILD_EXAMPLES_PYTHON_BINDINGS=ON</span>, and requires a python installation including the development files to be installed. You can then build the special target <span class="tt">ActsPythonBindings</span> to build everything that can be accessed in python.</p>
<p>The build will create a setup script in <span class="tt">$BUILD_DIR/python/setup.sh</span> which modifies <span class="tt">$PYTHONPATH</span> so that you can import the <span class="tt">acts</span> module in python.</p>
<p>Here is a minimal example of a python script using the example bindings, which sets up the particle propagation and runs a few events.</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> os</div>
<div class="line"> </div>
<div class="line"><span class="keyword">import</span> acts</div>
<div class="line"><span class="keyword">from</span> acts <span class="keyword">import</span> UnitConstants <span class="keyword">as</span> u</div>
<div class="line"><span class="keyword">import</span> acts.examples</div>
<div class="line"><span class="keyword">from</span> acts.examples.simulation <span class="keyword">import</span> (</div>
<div class="line">    addParticleGun,</div>
<div class="line">    EtaConfig,</div>
<div class="line">    ParticleConfig,</div>
<div class="line">    MomentumConfig,</div>
<div class="line">)</div>
<div class="line"><span class="keyword">from</span> acts.examples.root <span class="keyword">import</span> (</div>
<div class="line">    RootPropagationSummaryWriter,</div>
<div class="line">    RootPropagationStepsWriter,</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">detector = acts.examples.GenericDetector()</div>
<div class="line">trackingGeometry = detector.trackingGeometry()</div>
<div class="line">s = acts.examples.Sequencer(events=10)</div>
<div class="line"> </div>
<div class="line">rnd = acts.examples.RandomNumbers(seed=42)</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> d <span class="keywordflow">in</span> detector.contextDecorators():</div>
<div class="line">    s.addContextDecorator(d)</div>
<div class="line"> </div>
<div class="line">rnd = acts.examples.RandomNumbers(seed=42)</div>
<div class="line"> </div>
<div class="line">addParticleGun(</div>
<div class="line">    s,</div>
<div class="line">    ParticleConfig(num=1000, pdg=acts.PdgParticle.eMuon, randomizeCharge=<span class="keyword">True</span>),</div>
<div class="line">    EtaConfig(-4.0, 4.0),</div>
<div class="line">    MomentumConfig(1 * u.GeV, 100 * u.GeV, transverse=<span class="keyword">True</span>),</div>
<div class="line">    rnd=rnd,</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">trkParamExtractor = acts.examples.ParticleTrackParamExtractor(</div>
<div class="line">    level=acts.logging.WARNING,</div>
<div class="line">    inputParticles=<span class="stringliteral">&quot;particles_generated&quot;</span>,</div>
<div class="line">    outputTrackParameters=<span class="stringliteral">&quot;params_particles_generated&quot;</span>,</div>
<div class="line">)</div>
<div class="line">s.addAlgorithm(trkParamExtractor)</div>
<div class="line"> </div>
<div class="line">nav = acts.Navigator(trackingGeometry=trackingGeometry)</div>
<div class="line"> </div>
<div class="line">field = acts.ConstantBField(acts.Vector3(0, 0, 2 * acts.UnitConstants.T))</div>
<div class="line">stepper = acts.EigenStepper(field)</div>
<div class="line"> </div>
<div class="line">propagator = acts.examples.ConcretePropagator(acts.Propagator(stepper, nav))</div>
<div class="line"> </div>
<div class="line">propagationAlgorithm = acts.examples.PropagationAlgorithm(</div>
<div class="line">    propagatorImpl=propagator,</div>
<div class="line">    level=acts.logging.INFO,</div>
<div class="line">    sterileLogger=<span class="keyword">False</span>,</div>
<div class="line">    inputTrackParameters=<span class="stringliteral">&quot;params_particles_generated&quot;</span>,</div>
<div class="line">    outputSummaryCollection=<span class="stringliteral">&quot;propagation_summary&quot;</span>,</div>
<div class="line">)</div>
<div class="line">s.addAlgorithm(propagationAlgorithm)</div>
<div class="line"> </div>
<div class="line">s.addWriter(</div>
<div class="line">    RootPropagationSummaryWriter(</div>
<div class="line">        level=acts.logging.INFO,</div>
<div class="line">        inputSummaryCollection=<span class="stringliteral">&quot;propagation_summary&quot;</span>,</div>
<div class="line">        filePath=outputDir + <span class="stringliteral">&quot;/propagation_summary.root&quot;</span>,</div>
<div class="line">    )</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">s.addWriter(</div>
<div class="line">    RootPropagationStepsWriter(</div>
<div class="line">        level=acts.logging.INFO,</div>
<div class="line">        collection=<span class="stringliteral">&quot;propagation_summary&quot;</span>,</div>
<div class="line">        filePath=outputDir + <span class="stringliteral">&quot;/propagation_steps.root&quot;</span>,</div>
<div class="line">    )</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">s.run()</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md68"></a>
Python based example scripts</h2>
<p>The repository contains a set of example scripts that can be used to execute various workflows. They can be found in <span class="tt">$REPO_ROOT/Examples/Scripts/Python</span>. Make sure you have run</p>
<div class="fragment"><div class="line">source $BUILD_DIR/python/setup.sh</div>
</div><!-- fragment --><p>to make sure python can find the <span class="tt">acts</span> module.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md69"></a>
Python based unit tests</h2>
<p>A number of unit tests based on the <span class="tt">pytest</span> library are shipped with the repository. They are located under <span class="tt">$REPO_ROOT/Examples/Python/tests</span>, and intend to cover the public API of the python bindings. A set of tests also executed the standalone example scripts.</p>
<p>To run these python based tests, <span class="tt">pytest</span> and a few other dependencies need to be installed. They can be installed via <span class="tt">pip install -r
Examples/Python/tests/requirements.txt</span> from the repository root. You can then simply run <span class="tt">pytest</span> from the repository root.</p>
<dl class="section remark"><dt>Remarks</dt><dd>It is <b>strongly recommended</b> to use a <a href="https://realpython.com/python-virtual-environments-a-primer/">virtual environment</a> for this purpose! For example, run <div class="fragment"><div class="line">python -m venv venv</div>
<div class="line">source venv/bin/activate</div>
</div><!-- fragment --> to create a local virtual environment, and then run the <span class="tt">pip</span> command above.</dd></dl>
<h2 class="doxsection"><a class="anchor" id="root_file_hashes"></a>
ROOT file hash regression checks</h2>
<p>In a number of cases, the python based test suite will run hash based regression tests against ROOT files that are written by the test workloads. These tests use a custom hash algorithm written in python, which hashes each individual entry of each <span class="tt">TTree</span> found in a file. These entry hashes are then sorted, concatenated and hashed again for the final output. This procedure ensures that if the ROOT file content changes, the hash changes, while also giving the same hash when the events stored in the file are reordered.</p>
<p>The tests are implemented by looking up a reference hash from a central data file <span class="tt">$REPO_ROOT/Examples/Python/tests/root_file_hashes.txt</span> that looks like</p>
<div class="fragment"><div class="line">test_ckf_tracks_example_full_seeding__performance_seeding_trees.root: 938bcc9b9425b12c620f5d0efa2c592817dfe92a18c309e97aa9d87412918620</div>
<div class="line">test_ckf_tracks_example_full_seeding__trackstates_ckf.root: 2faceafd4a521ff4030557301723e29c3d870edad052965eb644b824b57e2146</div>
<div class="line">test_ckf_tracks_example_truth_estimate__performance_seeding_trees.root: 5c0cf9e84af64e6814ab1ddf4cbaf4be6008ad8b2371b5b0241085b19d0fc52c</div>
<div class="line">test_ckf_tracks_example_truth_estimate__performance_seeding_trees.root: 5c0cf9e84af64e6814ab1ddf4cbaf4be6008ad8b2371b5b0241085b19d0fc52c</div>
<div class="line">test_ckf_tracks_example_truth_estimate__trackstates_ckf.root: ac4485c09a68fca3d056cb8d9adb81695e68d822629e48c71fd2b6d2bbd31f88</div>
</div><!-- fragment --><p>where the left side before the <span class="tt">:</span> indicates the test in which the check is performed and the name of the ROOT file that is checked. The right side is the reference hash.</p>
<dl class="section note"><dt>Note</dt><dd>The file from which reference hashes are loaded can be changed by setting the environment variable <span class="tt">ROOT_HASH_FILE</span> to the desired file.</dd></dl>
<p>These checks have two purposes:</p>
<ol type="1">
<li>Detect regressions in the algorithms: if an algorithm produces different output, the test will catch it. This also means that if algorithmic changes are made that intentionally change the output, the reference hashes also have to be updated.</li>
</ol>
<dl class="section warning"><dt>Warning</dt><dd>Please make sure to check the contents of a changed file are correct/reasonable before updating the reference hash!</dd></dl>
<ol type="1">
<li>Detect potential reproducibility issues. Tests that run with multiple threads should produce the same output every run, event ordering aside. If a test workload has a thread-reproducibility issue, the output hash should also change.</li>
</ol>
<h3 class="doxsection"><a class="anchor" id="autotoc_md70"></a>
Running the hash checks locally and how to update the reference hashes</h3>
<p>By default, the hash checks are not executed when the <span class="tt">pytest</span> command is run. To enable them, you need to set the environment variable <span class="tt">ROOT_HASH_CHECKS</span> needs to be set to <span class="tt">ON</span>, for example like:</p>
<div class="fragment"><div class="line">ROOT_HASH_CHECKS=ON pytest</div>
</div><!-- fragment --><p>If any hash mismatches are observed, the corresponding tests will fail, and <span class="tt">pytest</span> will print a summary at the end that looks like</p>
<div class="fragment"><div class="line">------------------------------------------- RootHashAssertionErrors -----------------------------------------------------</div>
<div class="line">The ROOT files produced by tests have changed since the last recorded reference.</div>
<div class="line">This can be be expected if e.g. the underlying algorithm changed, or it can be a test failure symptom.</div>
<div class="line">Please manually check the output files listed below and make sure that their content is correct.</div>
<div class="line">If it is, you can update the test reference file Examples/Python/tests/root_file_hashes.txt with the new hashes below.</div>
<div class="line"> </div>
<div class="line">test_seeding__estimatedparams.root: 8bbc97cb3d4777c61dd0b483a1c8268fc8411ad182c35bc731e5ed222450deca</div>
<div class="line">test_material_recording__geant4_material_tracks.root: 019ce62ce378efa5c02a94768039686ed3cdfbd60c115c1f0cab2cbc53def57b</div>
<div class="line">test_material_mapping__material-maps_tracks.root: c03215e8b53733a3a7d7a0a5f9aec5bf2df20e8e40cc0492a8fa22400491d216</div>
<div class="line">test_material_mapping__propagation-material.root: a15a5c1e92fc3b848efb232eea1d40c422ee3a1d9ef1f7140294415621a04ce5</div>
<div class="line">test_ckf_tracks_example_full_seeding__tracksummary_ckf.root: 9e4d14169f20961be38d0305853a7cf7eeea4a647f0c94a48aada22c3c2c7a51</div>
<div class="line">test_ckf_tracks_example_truth_estimate__tracksummary_ckf.root: 3d56b26788163852e2c1f7288920f60a505bd14deeabb6f9189b680fcd90bfc5</div>
<div class="line">test_ckf_tracks_example_truth_smeared__tracksummary_ckf.root: ca2ce4069d2a2388c3d3c826dec8bea9f9d1e622239a20f8b985784d6c546c6e</div>
<div class="line">=========================================== short test summary info =====================================================</div>
<div class="line">FAILED Examples/Python/tests/test_examples.py::test_seeding</div>
<div class="line">FAILED Examples/Python/tests/test_examples.py::test_material_recording</div>
<div class="line">FAILED Examples/Python/tests/test_examples.py::test_material_mapping</div>
<div class="line">FAILED Examples/Python/tests/test_examples.py::test_ckf_tracks_example_full_seeding</div>
<div class="line">FAILED Examples/Python/tests/test_examples.py::test_ckf_tracks_example_truth_estimate</div>
<div class="line">FAILED Examples/Python/tests/test_examples.py::test_ckf_tracks_example_truth_smeared</div>
<div class="line">================================== 6 failed, 183 passed in 199.82s (0:03:19) ============================================</div>
</div><!-- fragment --><p>Here, we see that 7 hash checks have failed. The error output conveniently has the same format as the reference hashes found in <span class="tt">root_file_hashes.txt</span>. To update the reference hashes, simply replace the corresponding entries in <span class="tt">root_file_hashes.txt</span> with the output from the <span class="tt">pytest</span> run.</p>
<dl class="section note"><dt>Note</dt><dd>CI runs the ROOT hash checks. However, we have observed the hashes to change between different machines. This is believed to be due to differences in math libraries producing slightly different outputs. As a consequence, locally obtained file hashes might cause CI failures, as the CI hashes are different. <br  />
<br  />
 For local testing, it is therefore advisable to use <span class="tt">ROOT_HASH_FILE</span> to use a different file for the reference hashes and populated it with known-good reference hashes from the <span class="tt">main</span> branch, before testing your developments. <br  />
<br  />
 To make the CI succeed if it obtains different hashes than you get locally: make sure that the output is correct, and then update the central <span class="tt">root_file_hashes.txt</span> with the hashes reported in the failed CI job. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
